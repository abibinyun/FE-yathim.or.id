---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ShareButtons from "../../components/ShareButtons.astro";

const STORAGE_URL = "https://sys.yathim.or.id/storage";
const SITE = "https://yathim.or.id";

export async function getStaticPaths() {
  let articles: any[] = [];

  try {
    // Ambil semua artikel sekaligus untuk prebuild
    const articleRes = await fetch(`https://sys.yathim.or.id/api/articles/all/slug`);
    if (articleRes.ok) {
      const articleData = await articleRes.json();
      articles = articleData.data || [];
    }
  } catch (error) {
    console.error("Error fetching articles for static paths:", error);
    return [];
  }

  // Return params + props (optimisasi build time)
  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;

if (!article) {
  return Astro.redirect("/404");
}

// Helpers
const truncateText = (text: string, maxLength: number) => {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength - 3).trim() + "...";
};

const cleanText = (text: string) => {
  if (!text) return "";
  return text.replace(/\s+/g, " ").replace(/<[^>]*>/g, "").trim();
};

const formatDate = (dateString: string) => {
  if (!dateString) return "";
  const date = new Date(dateString);
  return date.toISOString();
};

// SEO data
const articleTitle = cleanText(article.title || article.name || "");
const articleDescription = cleanText(article.excerpt || article.description || "");
const articleImage = article.featured_image || article.image;
const fullImageUrl = articleImage
  ? `${STORAGE_URL}/${articleImage}`
  : `${SITE}/images/image-yathim.jpeg`;

const seoTitle = truncateText(`${articleTitle} - Yayasan Taman Harapan Insan Mulia`, 60);
const seoDescription = truncateText(
  articleDescription || `Baca artikel ${articleTitle} di website resmi Yayasan Taman Harapan Insan Mulia`,
  160
);
const publishedTime = formatDate(article.published_at || article.created_at);
const modifiedTime = formatDate(article.updated_at);

const FbPixel = article?.facebook_pixel;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  image={fullImageUrl}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  keywords={`artikel, ${articleTitle}, yayasan, sosial, pendidikan, kesehatan`}
  facebook_pixel={FbPixel}
>
  <!-- HERO -->
  <section class="bg-gradient-to-br from-primary-600 to-primary-800 text-white py-16">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <nav class="text-primary-200 mb-6">
          <a href="/" class="hover:text-white">Beranda</a>
          <span class="mx-2">/</span>
          <a href="/artikel" class="hover:text-white">Artikel</a>
          <span class="mx-2">/</span>
          <span class="text-white">{article.title}</span>
        </nav>

        <h1 class="text-3xl md:text-5xl font-bold mb-6 leading-tight">
          {article.title}
        </h1>

        <div class="flex items-center gap-4 mb-6">
          <span class="text-primary-100 text-sm">Bagikan artikel ini:</span>
          <ShareButtons
            url={`${SITE}/artikel/${article.slug}`}
            title={`${article.title} - Yayasan Taman Harapan Insan Mulia`}
            description={article.description || article.excerpt || ""}
            image={article.image ? `${STORAGE_URL}/${article.image}` : ""}
            size="sm"
            variant="horizontal"
            className="opacity-90 hover:opacity-100"
          />
        </div>
      </div>
    </div>
  </section>

  <!-- BODY -->
  <section class="py-16">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <!-- Artikel Utama -->
        <div class="lg:col-span-2">
          {(article.image || article.featured_image) && (
            <div class="aspect-video bg-gray-200 rounded-lg overflow-hidden mb-8 -mt-8">
              <img
                src={`${STORAGE_URL}/${article.image || article.featured_image}`}
                alt={article.title}
                class="w-full h-full object-cover"
              />
            </div>
          )}

          <div class="prose prose-lg max-w-none">
            {article.content ? (
              <div set:html={article.content} />
            ) : (
              <p class="text-gray-700 leading-relaxed">{article.description}</p>
            )}
          </div>

          {article.tags && article.tags.length > 0 && (
            <div class="mt-8 flex flex-wrap gap-2">
              {article.tags.map((tag: string) => (
                <span class="px-3 py-1 bg-primary-100 text-primary-700 text-sm rounded-full">{tag}</span>
              ))}
            </div>
          )}
        </div>

        <!-- Sidebar kosong (bisa isi artikel populer / kategori nanti) -->
        <!-- <div class="lg:col-span-1">
          <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Artikel Terbaru</h3>
            <p class="text-gray-600 text-sm">
              Nantikan artikel inspiratif dan berita terbaru dari Yayasan Taman Harapan Insan Mulia.
            </p>
          </div>
        </div> -->
      </div>
    </div>
  </section>

  <!-- Artikel Lainnya -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">Artikel Lainnya</h2>
      <p class="text-gray-600 mb-8">Baca artikel menarik lainnya dari yayasan kami</p>
      <a
        href="/artikel"
        class="bg-primary-600 hover:bg-primary-700 text-white font-semibold px-8 py-3 rounded-lg transition-colors inline-flex items-center"
      >
        Lihat Semua Artikel
        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div>
  </section>
</BaseLayout>
